revoke delete on table "public"."articles" from "anon";

revoke insert on table "public"."articles" from "anon";

revoke references on table "public"."articles" from "anon";

revoke select on table "public"."articles" from "anon";

revoke trigger on table "public"."articles" from "anon";

revoke truncate on table "public"."articles" from "anon";

revoke update on table "public"."articles" from "anon";

revoke delete on table "public"."articles" from "authenticated";

revoke insert on table "public"."articles" from "authenticated";

revoke references on table "public"."articles" from "authenticated";

revoke select on table "public"."articles" from "authenticated";

revoke trigger on table "public"."articles" from "authenticated";

revoke truncate on table "public"."articles" from "authenticated";

revoke update on table "public"."articles" from "authenticated";

revoke delete on table "public"."articles" from "service_role";

revoke insert on table "public"."articles" from "service_role";

revoke references on table "public"."articles" from "service_role";

revoke select on table "public"."articles" from "service_role";

revoke trigger on table "public"."articles" from "service_role";

revoke truncate on table "public"."articles" from "service_role";

revoke update on table "public"."articles" from "service_role";

revoke delete on table "public"."comments" from "anon";

revoke insert on table "public"."comments" from "anon";

revoke references on table "public"."comments" from "anon";

revoke select on table "public"."comments" from "anon";

revoke trigger on table "public"."comments" from "anon";

revoke truncate on table "public"."comments" from "anon";

revoke update on table "public"."comments" from "anon";

revoke delete on table "public"."comments" from "authenticated";

revoke insert on table "public"."comments" from "authenticated";

revoke references on table "public"."comments" from "authenticated";

revoke select on table "public"."comments" from "authenticated";

revoke trigger on table "public"."comments" from "authenticated";

revoke truncate on table "public"."comments" from "authenticated";

revoke update on table "public"."comments" from "authenticated";

revoke delete on table "public"."comments" from "service_role";

revoke insert on table "public"."comments" from "service_role";

revoke references on table "public"."comments" from "service_role";

revoke select on table "public"."comments" from "service_role";

revoke trigger on table "public"."comments" from "service_role";

revoke truncate on table "public"."comments" from "service_role";

revoke update on table "public"."comments" from "service_role";

revoke delete on table "public"."devices" from "anon";

revoke insert on table "public"."devices" from "anon";

revoke references on table "public"."devices" from "anon";

revoke select on table "public"."devices" from "anon";

revoke trigger on table "public"."devices" from "anon";

revoke truncate on table "public"."devices" from "anon";

revoke update on table "public"."devices" from "anon";

revoke delete on table "public"."devices" from "authenticated";

revoke insert on table "public"."devices" from "authenticated";

revoke references on table "public"."devices" from "authenticated";

revoke select on table "public"."devices" from "authenticated";

revoke trigger on table "public"."devices" from "authenticated";

revoke truncate on table "public"."devices" from "authenticated";

revoke update on table "public"."devices" from "authenticated";

revoke delete on table "public"."devices" from "service_role";

revoke insert on table "public"."devices" from "service_role";

revoke references on table "public"."devices" from "service_role";

revoke select on table "public"."devices" from "service_role";

revoke trigger on table "public"."devices" from "service_role";

revoke truncate on table "public"."devices" from "service_role";

revoke update on table "public"."devices" from "service_role";

revoke delete on table "public"."likes" from "anon";

revoke insert on table "public"."likes" from "anon";

revoke references on table "public"."likes" from "anon";

revoke select on table "public"."likes" from "anon";

revoke trigger on table "public"."likes" from "anon";

revoke truncate on table "public"."likes" from "anon";

revoke update on table "public"."likes" from "anon";

revoke delete on table "public"."likes" from "authenticated";

revoke insert on table "public"."likes" from "authenticated";

revoke references on table "public"."likes" from "authenticated";

revoke select on table "public"."likes" from "authenticated";

revoke trigger on table "public"."likes" from "authenticated";

revoke truncate on table "public"."likes" from "authenticated";

revoke update on table "public"."likes" from "authenticated";

revoke delete on table "public"."likes" from "service_role";

revoke insert on table "public"."likes" from "service_role";

revoke references on table "public"."likes" from "service_role";

revoke select on table "public"."likes" from "service_role";

revoke trigger on table "public"."likes" from "service_role";

revoke truncate on table "public"."likes" from "service_role";

revoke update on table "public"."likes" from "service_role";

revoke delete on table "public"."notification_promotions" from "anon";

revoke insert on table "public"."notification_promotions" from "anon";

revoke references on table "public"."notification_promotions" from "anon";

revoke select on table "public"."notification_promotions" from "anon";

revoke trigger on table "public"."notification_promotions" from "anon";

revoke truncate on table "public"."notification_promotions" from "anon";

revoke update on table "public"."notification_promotions" from "anon";

revoke delete on table "public"."notification_promotions" from "authenticated";

revoke insert on table "public"."notification_promotions" from "authenticated";

revoke references on table "public"."notification_promotions" from "authenticated";

revoke select on table "public"."notification_promotions" from "authenticated";

revoke trigger on table "public"."notification_promotions" from "authenticated";

revoke truncate on table "public"."notification_promotions" from "authenticated";

revoke update on table "public"."notification_promotions" from "authenticated";

revoke delete on table "public"."notification_promotions" from "service_role";

revoke insert on table "public"."notification_promotions" from "service_role";

revoke references on table "public"."notification_promotions" from "service_role";

revoke select on table "public"."notification_promotions" from "service_role";

revoke trigger on table "public"."notification_promotions" from "service_role";

revoke truncate on table "public"."notification_promotions" from "service_role";

revoke update on table "public"."notification_promotions" from "service_role";

revoke delete on table "public"."posts" from "anon";

revoke insert on table "public"."posts" from "anon";

revoke references on table "public"."posts" from "anon";

revoke select on table "public"."posts" from "anon";

revoke trigger on table "public"."posts" from "anon";

revoke truncate on table "public"."posts" from "anon";

revoke update on table "public"."posts" from "anon";

revoke delete on table "public"."posts" from "authenticated";

revoke insert on table "public"."posts" from "authenticated";

revoke references on table "public"."posts" from "authenticated";

revoke select on table "public"."posts" from "authenticated";

revoke trigger on table "public"."posts" from "authenticated";

revoke truncate on table "public"."posts" from "authenticated";

revoke update on table "public"."posts" from "authenticated";

revoke delete on table "public"."posts" from "service_role";

revoke insert on table "public"."posts" from "service_role";

revoke references on table "public"."posts" from "service_role";

revoke select on table "public"."posts" from "service_role";

revoke trigger on table "public"."posts" from "service_role";

revoke truncate on table "public"."posts" from "service_role";

revoke update on table "public"."posts" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."support_messages" from "anon";

revoke insert on table "public"."support_messages" from "anon";

revoke references on table "public"."support_messages" from "anon";

revoke select on table "public"."support_messages" from "anon";

revoke trigger on table "public"."support_messages" from "anon";

revoke truncate on table "public"."support_messages" from "anon";

revoke update on table "public"."support_messages" from "anon";

revoke delete on table "public"."support_messages" from "authenticated";

revoke insert on table "public"."support_messages" from "authenticated";

revoke references on table "public"."support_messages" from "authenticated";

revoke select on table "public"."support_messages" from "authenticated";

revoke trigger on table "public"."support_messages" from "authenticated";

revoke truncate on table "public"."support_messages" from "authenticated";

revoke update on table "public"."support_messages" from "authenticated";

revoke delete on table "public"."support_messages" from "service_role";

revoke insert on table "public"."support_messages" from "service_role";

revoke references on table "public"."support_messages" from "service_role";

revoke select on table "public"."support_messages" from "service_role";

revoke trigger on table "public"."support_messages" from "service_role";

revoke truncate on table "public"."support_messages" from "service_role";

revoke update on table "public"."support_messages" from "service_role";

revoke delete on table "public"."sync_analytics" from "anon";

revoke insert on table "public"."sync_analytics" from "anon";

revoke references on table "public"."sync_analytics" from "anon";

revoke select on table "public"."sync_analytics" from "anon";

revoke trigger on table "public"."sync_analytics" from "anon";

revoke truncate on table "public"."sync_analytics" from "anon";

revoke update on table "public"."sync_analytics" from "anon";

revoke delete on table "public"."sync_analytics" from "authenticated";

revoke insert on table "public"."sync_analytics" from "authenticated";

revoke references on table "public"."sync_analytics" from "authenticated";

revoke select on table "public"."sync_analytics" from "authenticated";

revoke trigger on table "public"."sync_analytics" from "authenticated";

revoke truncate on table "public"."sync_analytics" from "authenticated";

revoke update on table "public"."sync_analytics" from "authenticated";

revoke delete on table "public"."sync_analytics" from "service_role";

revoke insert on table "public"."sync_analytics" from "service_role";

revoke references on table "public"."sync_analytics" from "service_role";

revoke select on table "public"."sync_analytics" from "service_role";

revoke trigger on table "public"."sync_analytics" from "service_role";

revoke truncate on table "public"."sync_analytics" from "service_role";

revoke update on table "public"."sync_analytics" from "service_role";

revoke delete on table "public"."user_sync_data" from "anon";

revoke insert on table "public"."user_sync_data" from "anon";

revoke references on table "public"."user_sync_data" from "anon";

revoke select on table "public"."user_sync_data" from "anon";

revoke trigger on table "public"."user_sync_data" from "anon";

revoke truncate on table "public"."user_sync_data" from "anon";

revoke update on table "public"."user_sync_data" from "anon";

revoke delete on table "public"."user_sync_data" from "authenticated";

revoke insert on table "public"."user_sync_data" from "authenticated";

revoke references on table "public"."user_sync_data" from "authenticated";

revoke select on table "public"."user_sync_data" from "authenticated";

revoke trigger on table "public"."user_sync_data" from "authenticated";

revoke truncate on table "public"."user_sync_data" from "authenticated";

revoke update on table "public"."user_sync_data" from "authenticated";

revoke delete on table "public"."user_sync_data" from "service_role";

revoke insert on table "public"."user_sync_data" from "service_role";

revoke references on table "public"."user_sync_data" from "service_role";

revoke select on table "public"."user_sync_data" from "service_role";

revoke trigger on table "public"."user_sync_data" from "service_role";

revoke truncate on table "public"."user_sync_data" from "service_role";

revoke update on table "public"."user_sync_data" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Check if this is a guest user based on email pattern
  IF NEW.email LIKE '%@guest.local' THEN
    INSERT INTO public.profiles (id, user_id, email, is_guest)
    VALUES (NEW.id, NEW.id, NEW.email, true);
  ELSE
    INSERT INTO public.profiles (id, user_id, email, is_guest)
    VALUES (NEW.id, NEW.id, NEW.email, false);
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_post_comments_count()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- When a comment is INSERTED
  IF TG_OP = 'INSERT' THEN
    UPDATE posts 
    SET comments_count = comments_count + 1
    WHERE id = NEW.post_id;
    RETURN NEW;
  END IF;
  
  -- When a comment is DELETED
  IF TG_OP = 'DELETE' THEN
    UPDATE posts 
    SET comments_count = comments_count - 1
    WHERE id = OLD.post_id;
    RETURN OLD;
  END IF;
  
  -- When a comment is UPDATED (post_id changed)
  IF TG_OP = 'UPDATE' THEN
    -- Decrement count for old post
    UPDATE posts 
    SET comments_count = comments_count - 1
    WHERE id = OLD.post_id;
    
    -- Increment count for new post
    UPDATE posts 
    SET comments_count = comments_count + 1
    WHERE id = NEW.post_id;
    
    RETURN NEW;
  END IF;
  
  RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$function$
;


CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE FUNCTION handle_new_user();


  create policy "Allow authenticated users to upload to community 1ajt695_0"
  on "storage"."objects"
  as permissive
  for insert
  to public
with check (((bucket_id = 'community'::text) AND (auth.uid() IS NOT NULL)));



